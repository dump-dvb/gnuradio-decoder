#include <iostream>
#include <sstream>
#include <stdlib.h>
#include <string>
#include <fstream>

#include "correlate_access_code_bb_ts_fl.h"
#include "rational_resampler.h"
#include <gnuradio/analog/pwr_squelch_cc.h>
#include <gnuradio/analog/quadrature_demod_cf.h>
#include <gnuradio/blocks/multiply_const.h>
#include <gnuradio/blocks/socket_pdu.h>
#include <gnuradio/blocks/tagged_stream_to_pdu.h>
#include <gnuradio/constants.h>
#include <gnuradio/digital/binary_slicer_fb.h>
#include <gnuradio/digital/clock_recovery_mm_ff.h>
#include <gnuradio/digital/symbol_sync_ff.h>
#include <gnuradio/filter/fir_filter_blk.h>
#include <gnuradio/filter/firdes.h>
#include <gnuradio/filter/freq_xlating_fir_filter.h>
#include <gnuradio/filter/hilbert_fc.h>
#include <gnuradio/logger.h>
#include <gnuradio/prefs.h>
#include <gnuradio/sys_paths.h>
#include <gnuradio/top_block.h>
#include <osmosdr/source.h>

void usage(char *argv0) {
	std::cout << "Usage: " << argv0 << " {frequency} {offset} {rf} {if} {bb} [device]" << std::endl;
}

int main(int argc, char **argv) {
  gr::top_block_sptr tb;

  // Declare our GNU Radio blocks
  gr::filter::freq_xlating_fir_filter_ccc::sptr xlat;
  gr::filter::rational_resampler_ccc::sptr resampler;
  gr::analog::quadrature_demod_cf::sptr demod1, demod2;
  gr::filter::fir_filter_fff::sptr fir1, fir2;
  gr::filter::hilbert_fc::sptr hilbert;
  gr::digital::clock_recovery_mm_ff::sptr clockRecovery;
  gr::blocks::multiply_const_ff::sptr multiplyConst;
  gr::digital::binary_slicer_fb::sptr slicer;
  gr::reveng::correlate_access_code_bb_ts_fl::sptr correlate;
  gr::blocks::tagged_stream_to_pdu::sptr taggedStreamToPdu;
  gr::blocks::socket_pdu::sptr udp_client;

  float freq = 170795000;
  float xlat_center_freq = 19500;
  float samp_rate = 2000000;
  float bandwidth_sdr = 1000000;
  float bandwidth_xlat = 5000;
	float transition_bw = 1000;
  int decimation = static_cast<int>(bandwidth_sdr / bandwidth_xlat);
  float baud = 2400;
  unsigned rs_interpolation = 24;
  unsigned rs_decimation = 25;
  float sps = samp_rate / decimation / baud * (float) rs_interpolation / (float) rs_decimation;
	int RF, IF, BB;

	std::string device_string = "";

	// Argument parsing
	if (argc != 6 && argc != 7) {
		usage(*argv);
		return EXIT_FAILURE;
	}

	freq = strtof(argv[1], NULL);
	xlat_center_freq = strtof(argv[2], NULL);
	RF = atoi(argv[3]);
	IF = atoi(argv[4]);
	BB = atoi(argv[5]);

	if (argc == 7) {
		device_string = std::string(argv[6]);	
	}

  std::vector<gr_complex> xlat_taps = gr::filter::firdes::complex_band_pass(
      1, samp_rate, -samp_rate / (2 * decimation), samp_rate / (2 * decimation),
      transition_bw);
  gr_vector_float fir1_taps =
      gr::filter::firdes::high_pass(1.0, samp_rate / decimation, 100, 50);
  gr_vector_float fir2_taps = std::vector<float>({-0.0021235061971259825, -0.00024123636162899447, -0.001203382603982852, -0.0031681476888454764, -0.002349512849987051, -0.0003810167538936624, -0.0027852740654893938, -8.907587935127423e-05, -0.0008194568807834791, -0.0009764688844098859, -0.0013267158016127454, -7.755529565186734e-05, 0.00040070923279627137, -0.0035359143417868022, -0.0011376193267588859, 0.0010879825013195557, 0.0012316188373749457, 0.0007947711247370224, 6.13759350234853e-05, -0.0008411861386045807, 0.003674038192126826, 0.00037133931832311883, 0.0004633003528501909, 0.0001152069430418528, -0.0003631051805592163, -0.0013509045308084573, -0.0030781756851193795, 0.0010995810318630902, -0.0006984853390600357, -0.0010132241864759164, 0.00011107252083703134, 0.0037672117282095447, -0.001671187276825658, -0.0008764705988090879, 0.00040742320275851773, 0.0007801611238061055, -0.0011732580170285294, -0.0014353022328131458, 0.0009395819021850514, -4.343143498367996e-05, -0.0003378717969559378, -0.0016784299522017512, 0.0035328886890269697, 0.002154168680297381, 0.004014962490326964, 0.0007248743196813766, 0.00017838183122979346, 0.0009830313903371106, 0.0013508212999867356, 0.000642442337155743, 0.00030965147837457024, 0.0009875954642221561, 3.654366225869503e-05, 0.0025529286123139195, 0.003250700689372786, 0.0017635231351464543, -0.0012263208368835951, 0.00017547113464547442, -0.001957580968462272, 0.0004494497902823603, 0.0015768842973746795, 0.0009240685699274447, 0.0006332350408062233, -0.0010544513387491224, 0.0010624807287994429, -0.0018342651287467481, -0.00015661467294087936, 0.0003303216003265419, -0.0001390793001008572, -0.00016149961983865236, -0.0014742201814677617, 0.003182217905807977, -0.0007392980032505877, -0.0013848970563704408, 0.0009354163514908599, -0.0015004432147276007, -0.0007587452269834781, 0.002261062147080623, 0.0010925155949170096, 0.0007581384521443463, -0.001169210002982709, -0.0012808245952167607, 0.0005199732756975485, -0.0014197543667894184, -0.001434216527054793, -0.0002752741351256545, 0.002841880035557987, -0.0007671063298087188, -0.000612528130765796, -0.002009657745729688, 0.0028019822881871436, -0.0025587943027300967, -0.0009381946940344722, -0.001957547196645731, 0.0013415249343041282, 0.0007540610561389688, -0.0005792498156100451, 0.0023880836887697474, -0.0007549103322497474, 0.0011197308989944299, 9.110136923371653e-05, -0.00023731456256536373, 0.0014846033540311808, -0.00018302596384478455, 0.0023439219798068937, 0.0018942850890026185, 0.00016146285681692838, -0.001284662515423085, 0.003123784297305105, 0.0006939872494517728, 0.0010127006900659818, 0.0005386558808604085, 0.0001302965276613644, 0.0002603803036976709, 0.0031606641329887716, 0.002685901526281817, 0.0005384026447437937, 0.0006445937977522518, -0.00044349833471406903, 0.00023911808450215158, 0.0011559596091271437, 0.0006705799649968984, 0.0012141210199242665, -0.0012531019746836675, -0.002187268273518201, 0.0015329830364104976, 0.00024380588866857746, -0.00013476976821512983, 0.00045125865601818027, -0.0013577460762084726, -0.000610029950226851, 0.0002704648951707724, 0.0023459189077972165, -0.003403101790653287, 0.000575886970216499, 0.000679532052895706, 0.0006080293632201424, 0.00011690734826482792, -0.0009548517364262198, -0.0005633612737825429, 0.0018311060613288646, 0.002418475547049517, -0.0012497008506726236, 0.0010687918630532562, 0.0005568797938103858, -0.0006287321554543452, -0.00023393938918855542, -0.0009224841587394525, 0.0007534907706938599, -0.00199692608846649, 0.0004111583540073342, 0.002268927601100095, 0.0003621809782348141, 8.318116914413537e-05, 0.00036082371348599524, 0.0011122671579380011, 0.0012236270405040833, -0.001102571199410862, -0.0006126367184208767, -0.0013324272839480796, -0.0006290645895643428, -0.0021394342433204783, -0.002798071997831236, -0.0006178632963657216, -0.00045746941864224246, 0.0013457943172796522, -0.0018965810337460715, -7.01940430391947e-05, -0.0006760915384452671, -0.0006755182963059231, 0.0003652272877254417, 0.0013314383379120175, -0.0022660355272270064, 0.0013189972130207143, 0.0001695557647842443, 5.2412398101789326e-05, 0.0020514472422618665, -4.3294934819049246e-05, -0.0005450744310087803, 0.00037087020435935857, 0.00019715774254617526, 0.0007953309672904372, -0.0009030653963131179, 0.00035297788051014297, 0.0024288498331555765, -0.0028310386948668304, 0.0005962235943664364, -0.00031540679851141704, -0.0005714516368805261, 0.0020851675461051825, -0.0007594609627938101, -0.0021341540098111247, 0.002023589012685294, 0.002437966512132678, 9.643405283270556e-05, -0.0019617713526722765, -0.000611929795223071, -0.0006783744899825062, 0.0016755694616719125, -0.002502598511663613, 0.00021634665288235546, -0.0003666112299551007, -0.002717288360694984, 0.0017839608208689056, -0.0017273599405059448, -0.001978565408671631, 0.0011642991639934713, -0.000790809818016168, 0.001911443127872254, -0.002132604607866833, -0.0014528059377980863, 0.002176504474779233, 0.0005383845816698473, -0.0007130725536849597, -0.0008154237017762952, 0.0001110886574797414, -0.00026629690186592034, -0.0016442231352061072, 0.001079815654680276, 0.0013008472877245817, -0.0011512115489852458, 0.00035848939359564645, 0.0017950243505008947, -0.00046358193711399623, -0.0013747122981121707, -0.000620732070157519, -0.0007452240502545532, -0.00035471853079938444, -0.0013095644709928361, -0.0010804722865474427, -0.002276286778662407, 0.0016284739818219441, -0.00022073939513692542, -0.0016185047316231158, -0.0010263782863044768, -0.001376959399322102, -0.0018731002187647716, -0.001474343771126403, -0.000449548643857786, -0.000387168379960555, -0.0005479353297750208, 0.004060253594689847, -0.0010977250790995667, 0.00020772969448635626, 1.5995263429405878e-05, -0.0007193441616495582, -0.0011428709894580188, -0.0024128674316968315, -0.0007083924894409283, 0.0003209010315881789, -0.00214160796271346, -0.002570059575209646, -0.0010201935172232176, -0.0005886719705877783, -0.0007443487133354404, -0.0005983231061082392, 0.0009190977021507139, -0.0023723421318154235, 0.0003629309677727512, -0.0007341059107563356, -0.0028246240438295476, -0.0005343328794256551, -0.0016049294656540589, 0.0003678549501397808, -0.0014852026218503517, -0.0035969037545202755, -0.002457272600772686, 0.00048614591092095466, -0.002623542308963518, -0.00029515637473143726, -0.00019031986861929424, 0.000480320900638333, -0.0017012719163870234, -0.0008080056208915941, -0.0003571329746719706, -0.00018848847567875268, -7.275336164475462e-05, -0.0021047636120617476, -0.0007079407633163912, -0.000848952818264884, 0.0020753137662147124, -8.521168864951989e-05, -0.0024283255629974306, 3.615254851259994e-05, -0.0014661418196606003, 0.000515563498396789, 0.002137705207772284, 0.003202747920394099, 0.0027857408846654304, -0.0008050383182579795, -0.001033073230802671, 0.001862309543848234, -0.0006990171523058072, -0.002993582794096991, -0.0021151838014141114, -0.001796534911408619, -0.0012400010440903075, 0.0016496905130958402, 0.00031328515874103844, -0.0007576321817635324, -0.0004448581244717315, 0.001506042551171436, 0.0010178722716577837, 0.0018567016212899007, -0.0013982084649676015, 0.0004746637806614244, 0.0004755592869538658, 0.0030550018440516904, 0.000573996484356181, 0.00027035423589995267, -0.0007966130090296514, -0.00046024818330799537, 0.0011995129182156832, -0.00110312158825384, -1.693860428478468e-05, 0.0004263543671708238, 0.001905907593853741, 0.000831695460298126, 0.0033208718620740345, 0.0006690027409748524, -0.0006883529017630632, 0.00012858813994462496, 4.4811158406470736e-05, 0.0006494526065550818, 0.0003940131557040377, 0.0005810508761843716, 0.00011789609004909734, 0.002898689268705358, 0.0023176241068973845, 0.0005088214450311361, 0.0006383816222359359, 0.00012929888111291215, 0.0016403003652516238, -0.0011284066528284616, 0.0034694651562731395, 0.0015248618879923131, 0.0005569354408509698, 0.0004076399813901124, 0.0016698208516100735, -5.536853156693075e-06, 0.002160963493390303, -0.0023333160669777257, 0.0019398348868644906, -0.0004394442911143882, 0.0006473822440020507, 0.0006401608296625819, -0.0022179711611068583, -9.203723727562244e-05, 0.001474634239616482, 0.0013015875662714276, 0.0004092464623482571, 0.0032953946132261457, 0.000412374333676532, 0.0005893637619394745, 0.0010497959946838599, 0.003671242263556546, 0.003454924438899479, -0.0001386516622072756, 4.7354103642194105e-05, 0.001369754142046778, 0.00030831027260130287, 0.0013945604189376116, 0.002800863221768389, 0.0010740584422971086, 0.0017545083984049166, 3.603050845934461e-05, -0.0013600366724414792, 0.0036797637738001385, 0.0028656692717954524, -0.0003652409681634411, 0.0009517867848359504, -0.00045796245077185703, 0.0010055000423691437, 0.0014075625187529514, 0.00025118789454602205, 0.0008969733182244664, 0.0010634435317091366, 0.002189700014189609, 0.001466786155194157, -0.0008822143790280753, 0.00034933244221962306, -0.0026151700244779015, -0.0018951174877317892, -0.0023026396938746804, 0.0011861719420064704, 0.0024892491158630967, 6.379556008117287e-05, 0.0013271875642450993, -0.0026018917485294436, -0.0021106012422260866, -0.0005387260445521029, 0.0004914710343957456, -0.001804391230745172, -0.00028729161786387384, 0.0009681840881410231, -0.0029013340743959696, -0.001848206768952493, -0.004362682239943084, -0.0039043375690373822, -0.00024881696731463097, -0.003519307937441607, 0.0004423119730524183, -0.002813073745458529, -0.0021216630569232124, 2.4715959258446137e-05, -0.004008488982356445, -0.0015207052667871185, -0.004103405262721761, -0.0030510131821306755, -0.003413666027355106, -0.005334557990003796, -0.0030266900428256487, -0.0033986666976249646, -0.003572836121448926, -0.0022515278399434725, -0.0009588104859062764, -0.0003559345569528155, -0.004514136739422041, -0.002472896624025673, -0.004206949651780191, -0.003355327370579463, -0.0024920034391187488, -0.005270838978190953, -0.004640590478138087, -0.003716699955774832, -0.006401004178951355, -0.005418378376108748, -0.005991457787499728, -0.004261708681401004, -0.0031438087643425525, -0.005664852039744069, -0.006743791447091776, -0.0059666506079249365, -0.0054335865820485186, -0.004758513891264223, -0.004254270578031699, -0.0068766856668304515, -0.007915922157515467, -0.001408154681922329, -0.005490430854192467, -0.006260463362415461, -0.008239204694603994, -0.006623889781073796, -0.005677846464267821, -0.007467777890473354, -0.006072520688878331, -0.007700406080199984, -0.006891812022778223, -0.003290008922958932, -0.007286639535253555, -0.007574106286189812, -0.009455294333791147, -0.008735443650199048, -0.005028302917944041, -0.00710010056237457, -0.004433700688490258, -0.007595084845513302, -0.005471555507745298, -0.006875016692272923, -0.005953486367791624, -0.010805435802711948, -0.010285380820137986, -0.006656180540962531, -0.007596533523175438, -0.006511531534230963, -0.006399210092407905, -0.0067498770684685265, -0.009396031364375083, -0.00943681631200537, -0.007109301648116936, -0.00784327120565235, -0.00855987348038078, -0.010458219921811954, -0.006273508976547149, -0.008046472578927634, -0.009711402041394826, -0.006183446991837649, -0.011305791370095663, -0.015604434397415812, -0.012624897640219152, -0.009846726483287185, 0.19015371727210856, 0.19187918845706314, 0.19457301896246076, 0.19187918845706314, 0.19015371727210856, -0.009846726483287185, -0.012624897640219152, -0.015604434397415812, -0.011305791370095663, -0.006183446991837649, -0.009711402041394826, -0.008046472578927634, -0.006273508976547149, -0.010458219921811954, -0.00855987348038078, -0.00784327120565235, -0.007109301648116936, -0.00943681631200537, -0.009396031364375083, -0.0067498770684685265, -0.006399210092407905, -0.006511531534230963, -0.007596533523175438, -0.006656180540962531, -0.010285380820137986, -0.010805435802711948, -0.005953486367791624, -0.006875016692272923, -0.005471555507745298, -0.007595084845513302, -0.004433700688490258, -0.00710010056237457, -0.005028302917944041, -0.008735443650199048, -0.009455294333791147, -0.007574106286189812, -0.007286639535253555, -0.003290008922958932, -0.006891812022778223, -0.007700406080199984, -0.006072520688878331, -0.007467777890473354, -0.005677846464267821, -0.006623889781073796, -0.008239204694603994, -0.006260463362415461, -0.005490430854192467, -0.001408154681922329, -0.007915922157515467, -0.0068766856668304515, -0.004254270578031699, -0.004758513891264223, -0.0054335865820485186, -0.0059666506079249365, -0.006743791447091776, -0.005664852039744069, -0.0031438087643425525, -0.004261708681401004, -0.005991457787499728, -0.005418378376108748, -0.006401004178951355, -0.003716699955774832, -0.004640590478138087, -0.005270838978190953, -0.0024920034391187488, -0.003355327370579463, -0.004206949651780191, -0.002472896624025673, -0.004514136739422041, -0.0003559345569528155, -0.0009588104859062764, -0.0022515278399434725, -0.003572836121448926, -0.0033986666976249646, -0.0030266900428256487, -0.005334557990003796, -0.003413666027355106, -0.0030510131821306755, -0.004103405262721761, -0.0015207052667871185, -0.004008488982356445, 2.4715959258446137e-05, -0.0021216630569232124, -0.002813073745458529, 0.0004423119730524183, -0.003519307937441607, -0.00024881696731463097, -0.0039043375690373822, -0.004362682239943084, -0.001848206768952493, -0.0029013340743959696, 0.0009681840881410231, -0.00028729161786387384, -0.001804391230745172, 0.0004914710343957456, -0.0005387260445521029, -0.0021106012422260866, -0.0026018917485294436, 0.0013271875642450993, 6.379556008117287e-05, 0.0024892491158630967, 0.0011861719420064704, -0.0023026396938746804, -0.0018951174877317892, -0.0026151700244779015, 0.00034933244221962306, -0.0008822143790280753, 0.001466786155194157, 0.002189700014189609, 0.0010634435317091366, 0.0008969733182244664, 0.00025118789454602205, 0.0014075625187529514, 0.0010055000423691437, -0.00045796245077185703, 0.0009517867848359504, -0.0003652409681634411, 0.0028656692717954524, 0.0036797637738001385, -0.0013600366724414792, 3.603050845934461e-05, 0.0017545083984049166, 0.0010740584422971086, 0.002800863221768389, 0.0013945604189376116, 0.00030831027260130287, 0.001369754142046778, 4.7354103642194105e-05, -0.0001386516622072756, 0.003454924438899479, 0.003671242263556546, 0.0010497959946838599, 0.0005893637619394745, 0.000412374333676532, 0.0032953946132261457, 0.0004092464623482571, 0.0013015875662714276, 0.001474634239616482, -9.203723727562244e-05, -0.0022179711611068583, 0.0006401608296625819, 0.0006473822440020507, -0.0004394442911143882, 0.0019398348868644906, -0.0023333160669777257, 0.002160963493390303, -5.536853156693075e-06, 0.0016698208516100735, 0.0004076399813901124, 0.0005569354408509698, 0.0015248618879923131, 0.0034694651562731395, -0.0011284066528284616, 0.0016403003652516238, 0.00012929888111291215, 0.0006383816222359359, 0.0005088214450311361, 0.0023176241068973845, 0.002898689268705358, 0.00011789609004909734, 0.0005810508761843716, 0.0003940131557040377, 0.0006494526065550818, 4.4811158406470736e-05, 0.00012858813994462496, -0.0006883529017630632, 0.0006690027409748524, 0.0033208718620740345, 0.000831695460298126, 0.001905907593853741, 0.0004263543671708238, -1.693860428478468e-05, -0.00110312158825384, 0.0011995129182156832, -0.00046024818330799537, -0.0007966130090296514, 0.00027035423589995267, 0.000573996484356181, 0.0030550018440516904, 0.0004755592869538658, 0.0004746637806614244, -0.0013982084649676015, 0.0018567016212899007, 0.0010178722716577837, 0.001506042551171436, -0.0004448581244717315, -0.0007576321817635324, 0.00031328515874103844, 0.0016496905130958402, -0.0012400010440903075, -0.001796534911408619, -0.0021151838014141114, -0.002993582794096991, -0.0006990171523058072, 0.001862309543848234, -0.001033073230802671, -0.0008050383182579795, 0.0027857408846654304, 0.003202747920394099, 0.002137705207772284, 0.000515563498396789, -0.0014661418196606003, 3.615254851259994e-05, -0.0024283255629974306, -8.521168864951989e-05, 0.0020753137662147124, -0.000848952818264884, -0.0007079407633163912, -0.0021047636120617476, -7.275336164475462e-05, -0.00018848847567875268, -0.0003571329746719706, -0.0008080056208915941, -0.0017012719163870234, 0.000480320900638333, -0.00019031986861929424, -0.00029515637473143726, -0.002623542308963518, 0.00048614591092095466, -0.002457272600772686, -0.0035969037545202755, -0.0014852026218503517, 0.0003678549501397808, -0.0016049294656540589, -0.0005343328794256551, -0.0028246240438295476, -0.0007341059107563356, 0.0003629309677727512, -0.0023723421318154235, 0.0009190977021507139, -0.0005983231061082392, -0.0007443487133354404, -0.0005886719705877783, -0.0010201935172232176, -0.002570059575209646, -0.00214160796271346, 0.0003209010315881789, -0.0007083924894409283, -0.0024128674316968315, -0.0011428709894580188, -0.0007193441616495582, 1.5995263429405878e-05, 0.00020772969448635626, -0.0010977250790995667, 0.004060253594689847, -0.0005479353297750208, -0.000387168379960555, -0.000449548643857786, -0.001474343771126403, -0.0018731002187647716, -0.001376959399322102, -0.0010263782863044768, -0.0016185047316231158, -0.00022073939513692542, 0.0016284739818219441, -0.002276286778662407, -0.0010804722865474427, -0.0013095644709928361, -0.00035471853079938444, -0.0007452240502545532, -0.000620732070157519, -0.0013747122981121707, -0.00046358193711399623, 0.0017950243505008947, 0.00035848939359564645, -0.0011512115489852458, 0.0013008472877245817, 0.001079815654680276, -0.0016442231352061072, -0.00026629690186592034, 0.0001110886574797414, -0.0008154237017762952, -0.0007130725536849597, 0.0005383845816698473, 0.002176504474779233, -0.0014528059377980863, -0.002132604607866833, 0.001911443127872254, -0.000790809818016168, 0.0011642991639934713, -0.001978565408671631, -0.0017273599405059448, 0.0017839608208689056, -0.002717288360694984, -0.0003666112299551007, 0.00021634665288235546, -0.002502598511663613, 0.0016755694616719125, -0.0006783744899825062, -0.000611929795223071, -0.0019617713526722765, 9.643405283270556e-05, 0.002437966512132678, 0.002023589012685294, -0.0021341540098111247, -0.0007594609627938101, 0.0020851675461051825, -0.0005714516368805261, -0.00031540679851141704, 0.0005962235943664364, -0.0028310386948668304, 0.0024288498331555765, 0.00035297788051014297, -0.0009030653963131179, 0.0007953309672904372, 0.00019715774254617526, 0.00037087020435935857, -0.0005450744310087803, -4.3294934819049246e-05, 0.0020514472422618665, 5.2412398101789326e-05, 0.0001695557647842443, 0.0013189972130207143, -0.0022660355272270064, 0.0013314383379120175, 0.0003652272877254417, -0.0006755182963059231, -0.0006760915384452671, -7.01940430391947e-05, -0.0018965810337460715, 0.0013457943172796522, -0.00045746941864224246, -0.0006178632963657216, -0.002798071997831236, -0.0021394342433204783, -0.0006290645895643428, -0.0013324272839480796, -0.0006126367184208767, -0.001102571199410862, 0.0012236270405040833, 0.0011122671579380011, 0.00036082371348599524, 8.318116914413537e-05, 0.0003621809782348141, 0.002268927601100095, 0.0004111583540073342, -0.00199692608846649, 0.0007534907706938599, -0.0009224841587394525, -0.00023393938918855542, -0.0006287321554543452, 0.0005568797938103858, 0.0010687918630532562, -0.0012497008506726236, 0.002418475547049517, 0.0018311060613288646, -0.0005633612737825429, -0.0009548517364262198, 0.00011690734826482792, 0.0006080293632201424, 0.000679532052895706, 0.000575886970216499, -0.003403101790653287, 0.0023459189077972165, 0.0002704648951707724, -0.000610029950226851, -0.0013577460762084726, 0.00045125865601818027, -0.00013476976821512983, 0.00024380588866857746, 0.0015329830364104976, -0.002187268273518201, -0.0012531019746836675, 0.0012141210199242665, 0.0006705799649968984, 0.0011559596091271437, 0.00023911808450215158, -0.00044349833471406903, 0.0006445937977522518, 0.0005384026447437937, 0.002685901526281817, 0.0031606641329887716, 0.0002603803036976709, 0.0001302965276613644, 0.0005386558808604085, 0.0010127006900659818, 0.0006939872494517728, 0.003123784297305105, -0.001284662515423085, 0.00016146285681692838, 0.0018942850890026185, 0.0023439219798068937, -0.00018302596384478455, 0.0014846033540311808, -0.00023731456256536373, 9.110136923371653e-05, 0.0011197308989944299, -0.0007549103322497474, 0.0023880836887697474, -0.0005792498156100451, 0.0007540610561389688, 0.0013415249343041282, -0.001957547196645731, -0.0009381946940344722, -0.0025587943027300967, 0.0028019822881871436, -0.002009657745729688, -0.000612528130765796, -0.0007671063298087188, 0.002841880035557987, -0.0002752741351256545, -0.001434216527054793, -0.0014197543667894184, 0.0005199732756975485, -0.0012808245952167607, -0.001169210002982709, 0.0007581384521443463, 0.0010925155949170096, 0.002261062147080623, -0.0007587452269834781, -0.0015004432147276007, 0.0009354163514908599, -0.0013848970563704408, -0.0007392980032505877, 0.003182217905807977, -0.0014742201814677617, -0.00016149961983865236, -0.0001390793001008572, 0.0003303216003265419, -0.00015661467294087936, -0.0018342651287467481, 0.0010624807287994429, -0.0010544513387491224, 0.0006332350408062233, 0.0009240685699274447, 0.0015768842973746795, 0.0004494497902823603, -0.001957580968462272, 0.00017547113464547442, -0.0012263208368835951, 0.0017635231351464543, 0.003250700689372786, 0.0025529286123139195, 3.654366225869503e-05, 0.0009875954642221561, 0.00030965147837457024, 0.000642442337155743, 0.0013508212999867356, 0.0009830313903371106, 0.00017838183122979346, 0.0007248743196813766, 0.004014962490326964, 0.002154168680297381, 0.0035328886890269697, -0.0016784299522017512, -0.0003378717969559378, -4.343143498367996e-05, 0.0009395819021850514, -0.0014353022328131458, -0.0011732580170285294, 0.0007801611238061055, 0.00040742320275851773, -0.0008764705988090879, -0.001671187276825658, 0.0037672117282095447, 0.00011107252083703134, -0.0010132241864759164, -0.0006984853390600357, 0.0010995810318630902, -0.0030781756851193795, -0.0013509045308084573, -0.0003631051805592163, 0.0001152069430418528, 0.0004633003528501909, 0.00037133931832311883, 0.003674038192126826, -0.0008411861386045807, 6.13759350234853e-05, 0.0007947711247370224, 0.0012316188373749457, 0.0010879825013195557, -0.0011376193267588859, -0.0035359143417868022, 0.00040070923279627137, -7.755529565186734e-05, -0.0013267158016127454, -0.0009764688844098859, -0.0008194568807834791, -8.907587935127423e-05, -0.0027852740654893938, -0.0003810167538936624, -0.002349512849987051, -0.0031681476888454764, -0.001203382603982852, -0.00024123636162899447, -0.0021235061971259825});

  tb = gr::make_top_block("fg");

  osmosdr::source::sptr src;
  src = osmosdr::source::make(device_string);
  src->set_block_alias("src");

  src->set_sample_rate(samp_rate);
  src->set_center_freq(freq);
  src->set_gain_mode(false, 0);
  src->set_gain(RF, "RF", 0);
  src->set_gain(IF, "IF", 0);
  src->set_gain(BB, "BB", 0);
  src->set_bandwidth(bandwidth_sdr, 0);

  xlat = gr::filter::freq_xlating_fir_filter_ccc::make(
      decimation, xlat_taps, xlat_center_freq, samp_rate);
  resampler = gr::filter::rational_resampler_ccc::make(
    rs_interpolation, rs_decimation, std::vector<gr_complex>(), 0.4);
  demod1 = gr::analog::quadrature_demod_cf::make(1.0);
  fir1 = gr::filter::fir_filter_fff::make(1, fir1_taps);
  hilbert = gr::filter::hilbert_fc::make(65);
  demod2 = gr::analog::quadrature_demod_cf::make(4.0);
  fir2 = gr::filter::fir_filter_fff::make(1, fir2_taps);
  clockRecovery = gr::digital::clock_recovery_mm_ff::make(
      sps, 0.25f * 0.175f * 0.175f, 0.5, 0.175, 0.01);
  multiplyConst = gr::blocks::multiply_const_ff::make(-1.0f);
  slicer = gr::digital::binary_slicer_fb::make();
	// set this to 24 to receive all possible telegrams.
	// set it to 13 to receive not more data then needed for R09.16
  correlate = gr::reveng::correlate_access_code_bb_ts_fl::make(
      "1111110000000001", 1, "packet_len", 13);
  taggedStreamToPdu = gr::blocks::tagged_stream_to_pdu::make(
      gr::blocks::pdu::vector_type::byte_t, "packet_len");
  udp_client = gr::blocks::socket_pdu::make("UDP_CLIENT", "localhost", "40000");

  std::string ver = gr::version();
  std::string cCompiler = gr::c_compiler();
  std::string cxxCompiler = gr::cxx_compiler();
  std::string compilerFlags = gr::compiler_flags();
  std::string prefs = gr::prefs::singleton()->to_string();

  std::cout << "GNU Radio Version: " << ver << "\n\n C Compiler: " << cCompiler
            << "\n\n CXX Compiler: " << cxxCompiler << "\n\n Prefs: " << prefs
            << "\n\n Compiler Flags: " << compilerFlags << "\n\n";

  try {
    tb->connect(src, 0, xlat, 0);
    tb->connect(xlat, 0, resampler, 0);
    tb->connect(resampler, 0, demod1, 0);
    tb->connect(demod1, 0, fir1, 0);
    tb->connect(fir1, 0, hilbert, 0);
    tb->connect(hilbert, 0, demod2, 0);
    tb->connect(demod2, 0, fir2, 0);
    tb->connect(fir2, 0, clockRecovery, 0);
    tb->connect(clockRecovery, 0, multiplyConst, 0);
    tb->connect(multiplyConst, 0, slicer, 0);
    tb->connect(slicer, 0, correlate, 0);
    tb->connect(correlate, 0, taggedStreamToPdu, 0);
    tb->msg_connect(taggedStreamToPdu, "pdus", udp_client, "pdus");
  } catch (const std::invalid_argument &e) {
    std::cerr << e.what();
    return EXIT_FAILURE;
  }

  tb->start();

	tb->wait();

  return EXIT_SUCCESS;
}
